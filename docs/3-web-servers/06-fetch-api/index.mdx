---
title: Fetch API
---

前頁では、Webサーバーが動作する仕組みと、ブラウザとWebサーバーの間で行われる基本的な通信の手順について学びました。この流れの中では、ブラウザは、次のような場合に<Term>HTTPリクエスト</Term>をWebサーバーに対して送信するのでした。

1. アドレスバーにURLを入力したとき
2. リンクをクリックしたとき
3. 取得したHTMLに外部リソースを読み込むタグが含まれていたとき

しかし、この方法では、新しい情報を取得する度にブラウザのページ遷移が必要になるため、複雑なアプリケーションを構築するには不便です。**Fetch API**を用いると、ブラウザ上で動作するJavaScriptから、Webサーバーに対して直接HTTPリクエストを発行し、レスポンスを受け取ることができます。これにより、Webアプリケーションはページ遷移を伴わずに新しい情報を取得したり、サーバーと通信したりすることが可能になります。

## ブラウザで動作するJavaScriptでモジュールを用いる

JavaScriptを用いて複雑なプログラムを記載する際、1ファイルに含まれるJavaScriptのコードが長くなると、全体を把握するのが難しくなります。[モジュールとnpm](/docs/web-servers/module/)の章では、**モジュール**を用いることで、Node.jsにおいて巨大なコードを分割することができることを学びました。ブラウザにおいても同様にモジュールの仕組みが使用できます。

ブラウザでモジュールを使用するには、`script`タグの`type`属性に対し、`"module"`を指定します。これにより、読み込まれたJavaScriptがモジュールとして扱われ、`import`文や`export`文を使用できるようになります。ブラウザは、まだ取得されていないモジュールへの`import`文を見つけると、新しいリクエストを発行して、指定されたモジュールを読み込みます。

次の例では、`index.html`から`main.mjs`をモジュールとして読み込んでいます。`main.mjs`の中では、別のモジュールである`math.mjs`からエクスポートされた、`add`関数と`multiply`関数をインポートして使用しています。

```javascript title="main.mjs (サーバーとして動作するJavaScript)"
import express from "express";

const app = express();
app.use(express.static("./public"));
app.listen(3000);
```

```html title="public/index.html (抜粋)"
<h1>計算結果</h1>
<p id="result"></p>
<script type="module" src="./main.mjs"></script>
```

```javascript title="public/main.mjs (ブラウザ上で動作するJavaScript)"
import { add, multiply } from "./math.mjs";

const sum = add(3, 4);
const product = multiply(3, 4);

const resultElement = document.getElementById("result");
resultElement.textContent = `3 + 4 = ${sum}, 3 × 4 = ${product}`;
```

```javascript title="public/math.mjs (ブラウザ上で動作するJavaScript)"
export function add(a, b) {
  return a + b;
}

export function multiply(a, b) {
  return a * b;
}
```

<ViewSource url={import.meta.url} path="_samples/browser-module" />

この項以降、ブラウザで動作するJavaScriptのコードは、全てモジュールを用いて記述していきます。

:::warning[HTMLファイルをブラウザで開く場合]

第1章で使用したような、HTMLファイルを直接ブラウザで開く方法では、モジュールを使用できません。この例のように、Express等を用いてWebサーバーを構築し、Webサーバー経由でブラウザにHTMLを取得させる必要があります。

:::

## Fetch API

Fetch APIは、`fetch`関数を呼び出すことで実行できます。`fetch`関数にリクエストを発行したいURLを指定することで、HTTPリクエストを発行し、[`Response`](https://developer.mozilla.org/ja/docs/Web/API/Response)オブジェクトを取得できます。`Response`オブジェクトの[`text`メソッド](https://developer.mozilla.org/ja/docs/Web/API/Response/text)を呼び出すことで、<Term>レスポンスボディ</Term>を文字列として取得できます。

次の例では、ブラウザは`script.mjs`の中で`fetch("/weather")`が呼び出されたときに、Webサーバーに対して`/weather`というパスに対する<Term>リクエスト</Term>を発行します。Webサーバーは、`/weather`に対するリクエストを受け取ると、レスポンスとして「晴れ」という文字列を返します。ブラウザは、このレスポンスを受け取り、HTMLの中の`span`要素に「晴れ」という文字列を表示します。

`fetch`関数や `Response#text` メソッドは、時間のかかる処理を行うため、<Term>**非同期処理**</Term>としてバックグラウンドで実行されます。この例では、式`fetch("/weather")`の評価は直ちに完了しますが、まだHTTPリクエストは完了していません。`await fetch("/weather")`のように、**`await`演算子を適用**することで、HTTPリクエストが完了するまで待機し、実際のレスポンスを取得できます。

```javascript title="main.mjs (サーバーとして動作するJavaScript)"
import express from "express";

const app = express();
app.use(express.static("./public"));
app.get("/weather", (request, response) => {
  response.send("晴れ");
});
app.listen(3000);
```

```html title="public/index.html"
<p>本日の天気は<span id="weather"></span>です。</p>
<script type="module" src="./script.mjs"></script>
```

```javascript title="public/script.mjs (ブラウザ上で動作するJavaScript)"
// http://localhost:3000/weather に HTTP リクエストを送信
// fetch 関数は非同期処理を行うため、await を演算子を適用して完了を待機する
const response = await fetch("/weather");

// レスポンスをテキストとして取得
const weather = await response.text();

const weatherElement = document.getElementById("weather");
weatherElement.textContent = weather;
```

<ViewSource url={import.meta.url} path="_samples/fetch-weather" />

:::tip[非同期処理]

JavaScriptにおける<Term>**非同期処理**</Term>とは、ファイルの入出力やネットワーク通信など、JavaScriptの外側の時間のかかる処理の完了を待つ間、ほかの処理を実行できるようにする仕組みです。非同期処理を行う関数を使用するためには、次の2つのルールを守る必要があります。

- 非同期処理を行う関数を呼び出す関数を定義する際、`async`キーワードをつけること
  - ただし、モジュールのトップレベル (関数の外側) では、`async`キーワードは不要
- 非同期処理を行う関数の戻り値に対し、`await`演算子を適用すること

非同期処理を行う関数の戻り値の実態は、`Promise`と呼ばれるオブジェクトです。`await`演算子は、`Promise`オブジェクトに作用し、その処理が完了するまで待機します。詳細は、[MDNの記事](https://developer.mozilla.org/ja/docs/Learn/JavaScript/Asynchronous)を参照してください。

:::

## 演習問題1

Fetch APIを用いて為替レート（円/ドル）を取得するプログラムを作成してください。為替レートは、サーバー側で乱数を用いて生成してください。ページを開いたときに自動的に取得して表示するようにしましょう。

### ヒント

- サーバー側で`/exchange-rate`というパスに対する<Term>GETリクエスト</Term>を処理する
- `Math.random()`を使って140円から160円の間の値を生成する
- クライアント側ではページ読み込み時（トップレベル）で`fetch`関数を使って取得する

<Answer title="為替レート取得プログラム">

```javascript title="main.mjs"
import express from "express";
const app = express();

app.use(express.static("./public"));

app.get("/exchange-rate", (request, response) => {
  const rate = (Math.random() * 20 + 140).toFixed(2);
  response.send(rate);
});

app.listen(3000);
```

```html title="public/index.html"
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>為替レート</title>
  </head>
  <body>
    <h1>円/ドル為替レート</h1>
    <p>現在のレート: <span id="rate">読み込み中...</span>円/ドル</p>
    <script type="module" src="./script.mjs"></script>
  </body>
</html>
```

```javascript title="public/script.mjs"
// ページ読み込み時に自動的に実行される（トップレベルのawait）
const response = await fetch("/exchange-rate");
const rate = await response.text();
document.getElementById("rate").textContent = rate;
```

<ViewSource url={import.meta.url} path="_samples/exchange-rate" />

</Answer>

## 演習問題2

通貨換算アプリケーションを作成してください。円の金額を入力してボタンをクリックすると、現在の為替レートでドルに換算して表示するプログラムです。

### ヒント

- 入力フィールドとボタンを用意する
- ボタンのクリックイベントで`fetch`関数を使って為替レートを取得する
- 取得したレートを使って換算結果を計算・表示する

:::warning[非同期関数と`async`キーワード]

`await`を使用する関数には必ず`async`キーワードを付ける必要があります。

```javascript
// ❌ エラーになる例
document.getElementById("convert-button").onclick = () => {
  const response = await fetch("/exchange-rate"); // SyntaxError: await は async 関数内でのみ使用可能
};

// ✅ 正しい例
document.getElementById("convert-button").onclick = async () => {
  const response = await fetch("/exchange-rate"); // OK!
};
```

:::

<Answer title="通貨換算アプリケーション">

```javascript title="main.mjs"
import express from "express";
const app = express();

app.use(express.static("./public"));

app.get("/exchange-rate", (request, response) => {
  const rate = (Math.random() * 20 + 140).toFixed(2);
  response.send(rate);
});

app.listen(3000);
```

```html title="public/index.html"
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>通貨換算</title>
  </head>
  <body>
    <h1>円→ドル通貨換算</h1>
    <div>
      <label>
        円: <input type="number" id="yen-input" placeholder="金額を入力" />
      </label>
      <button id="convert-button">換算する</button>
    </div>
    <div id="result"></div>
    <script type="module" src="./script.mjs"></script>
  </body>
</html>
```

```javascript title="public/script.mjs"
// ボタンクリックイベントに非同期関数を設定
// async キーワードが必要
document.getElementById("convert-button").onclick = async () => {
  const yenInput = document.getElementById("yen-input");
  const yenAmount = parseFloat(yenInput.value);
  
  if (isNaN(yenAmount) || yenAmount <= 0) {
    alert("正しい金額を入力してください");
    return;
  }
  
  // 為替レートを取得
  const response = await fetch("/exchange-rate");
  const rate = parseFloat(await response.text());
  
  // ドルに換算
  const dollarAmount = (yenAmount / rate).toFixed(2);
  
  // 結果を表示
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = `
    <p>為替レート: 1ドル = ${rate}円</p>
    <p>${yenAmount}円 = <strong>${dollarAmount}ドル</strong></p>
  `;
};
```

<ViewSource url={import.meta.url} path="_samples/currency-converter" />

</Answer>
